# üìã Prueba T√©cnica ‚Äì Registro de Personas en Laravel

Este proyecto es una soluci√≥n para la prueba t√©cnica que consiste en desarrollar una aplicaci√≥n web y una API REST con Laravel para el registro de personas. La aplicaci√≥n permite validar datos, registrar informaci√≥n adicional como IP y zona horaria, y enviar notificaciones por email y SMS de forma condicional.

## üõ†Ô∏è Requisitos

-   PHP >= 8.1
-   Composer
-   MySQL o MariaDB
-   Node.js y npm (si se usan assets frontend)
-   Laravel 10+
-   Cuenta de Gmail con App Password (para notificaciones por email)
-   Cuenta de Twilio (para notificaciones por SMS)

## üöÄ Instalaci√≥n

1. **Clonar el repositorio**

```bash
git clone https://github.com/jorshuadev/FormularioLaravel.git
cd FormularioLaravel
```

2. **Instalar dependencias**

```bash
composer install
```

3. **Instalar Twilio SDK para SMS**

```bash
composer require twilio/sdk
```

> Si usas assets (como Vue, React o Bootstrap):

```bash
npm install && npm run dev
```

4. **Configurar variables de entorno**

```bash
cp .env.example .env
```

Abre `.env` y configura tus datos:

```env
# Base de datos
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=formulario
DB_USERNAME=root
DB_PASSWORD=

# URL de la aplicaci√≥n
APP_URL=http://persona.test

# Configuraci√≥n de email (Gmail)
MAIL_MAILER=smtp
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=tu-email@gmail.com
MAIL_PASSWORD="tu-app-password"
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=tu-email@gmail.com
MAIL_FROM_NAME="Formulario"

# Configuraci√≥n de SMS (Twilio)
TWILIO_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_TOKEN=tu_auth_token_aqui
TWILIO_FROM=+1234567890

# Token para API
TOKEN_API=AMAXONIA_TOKEN

# Configuraci√≥n de colas
QUEUE_CONNECTION=database
SESSION_DRIVER=database
CACHE_STORE=database
```

5. **Generar la clave de la aplicaci√≥n**

```bash
php artisan key:generate
```

---

## üìß Configuraci√≥n de Email

### Configurar Gmail App Password

1. **Activar verificaci√≥n en 2 pasos** en tu cuenta de Google
2. **Generar App Password**:
    - Ve a [Configuraci√≥n de Google](https://myaccount.google.com/security)
    - Busca "Contrase√±as de aplicaciones"
    - Genera una nueva contrase√±a para "Correo"
3. **Usar la App Password** en `MAIL_PASSWORD` (no tu contrase√±a normal)

### Variables de Email Requeridas

```env
MAIL_MAILER=smtp
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=tu-email@gmail.com
MAIL_PASSWORD="app-password-de-16-caracteres"
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=tu-email@gmail.com
MAIL_FROM_NAME="Tu Aplicaci√≥n"
```

---

## üì± Configuraci√≥n de SMS con Twilio

### Crear Cuenta en Twilio

1. **Reg√≠strate** en [Twilio](https://www.twilio.com/)
2. **Completa la verificaci√≥n** de tu n√∫mero de tel√©fono
3. **Obt√©n $15 USD** de cr√©dito gratis para pruebas

### Obtener Credenciales de Twilio

1. **Ve al Dashboard** de Twilio
2. **Copia estas credenciales**:
    - **Account SID**: `ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`
    - **Auth Token**: Haz clic en "Show" para verlo
3. **Compra un n√∫mero de tel√©fono**:
    - Ve a Console ‚Üí Phone Numbers ‚Üí Manage ‚Üí Buy a number
    - Busca un n√∫mero con capacidades SMS
    - Compra el n√∫mero (gratis con cuenta trial)

### Variables de SMS Requeridas

```env
# Twilio SMS Configuration
TWILIO_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_TOKEN=tu_auth_token_real_aqui
TWILIO_FROM=+1234567890  # N√∫mero comprado en Twilio
```

### Configurar services.php

Agrega la configuraci√≥n de Twilio en `config/services.php`:

```php
'twilio' => [
    'sid' => env('TWILIO_SID'),
    'token' => env('TWILIO_TOKEN'),
    'from' => env('TWILIO_FROM'),
],
```

### Verificar N√∫meros de Destino (Solo para Trial)

Si usas cuenta trial de Twilio:

1. **Ve a**: Console ‚Üí Phone Numbers ‚Üí Manage ‚Üí Verified Caller IDs
2. **Agrega tu n√∫mero** de tel√©fono paname√±o (+507XXXXXXXX)
3. **Verifica** con el c√≥digo que te env√≠en por SMS

### Costos de Twilio

-   **Cuenta Trial**: $15 USD gratis
-   **SMS a Panam√°**: ~$0.075 USD por SMS
-   **N√∫mero de tel√©fono**: ~$1 USD/mes
-   **Capacidad con cr√©dito gratis**: ~200 SMS

### Limitaciones de Cuenta Trial

-   Solo puedes enviar SMS a **n√∫meros verificados**
-   Los SMS tendr√°n el prefijo: "Sent from your Twilio trial account - "
-   Para enviar a cualquier n√∫mero, necesitar√°s actualizar a cuenta pagada

---

## üóÉÔ∏è Migraciones y Configuraci√≥n de Base de Datos

```bash
# Crear las tablas
php artisan migrate

# Crear tabla de colas (para notificaciones)
php artisan queue:table
php artisan migrate

# Crear tabla de sesiones
php artisan session:table
php artisan migrate
```

---

## ‚öôÔ∏è Ejecutar la Aplicaci√≥n

```bash
php artisan serve
```

La app estar√° disponible en: [http://persona.test](http://persona.test) o [http://127.0.0.1:8000](http://127.0.0.1:8000)

### Rutas Disponibles

-   **Formulario Web**: `/personas/crear`
-   **Ver Registros**: `/personas/ver`
-   **API Endpoint**: `/api/personas`

---

## ‚è≥ Ejecutar Colas (Para Notificaciones Asincr√≥nicas)

```bash
php artisan queue:work
```

> **Nota**: Las colas son opcionales. Los emails y SMS se pueden enviar de forma s√≠ncrona sin configurar colas.

---

## üì¨ API REST

### Endpoint

```
POST /api/personas
```

### Headers

```
Authorization: AMAXONIA_TOKEN
Content-Type: application/json
Accept: application/json
```

### Cuerpo JSON de ejemplo

```json
{
    "nombre_completo": "Juan P√©rez",
    "tipo_documento": "cedula",
    "nro_documento": "123456789",
    "correo_electronico": "juan@example.com",
    "telefono": "61234567",
    "timezone": "America/Panama",
    "notificar_por_correo": true,
    "notificar_por_sms": true
}
```

### Respuesta exitosa

```json
{
    "success": true,
    "data": {
        "id": 1,
        "nombre": "Juan",
        "apellido": "P√©rez",
        "tipo_documento": "cedula",
        "nro_documento": "123456789",
        "correo_electronico": "juan@example.com",
        "telefono": "61234567",
        "notificacion_via_correo": true,
        "notificacion_via_sms": true,
        "ip": "127.0.0.1",
        "timezone": "America/Panama",
        "registro_via": "mobile",
        "created_at": "2024-01-15T10:30:00.000000Z",
        "updated_at": "2024-01-15T10:30:00.000000Z"
    },
    "message": "Persona registrada exitosamente. Email de confirmaci√≥n enviado. SMS de confirmaci√≥n enviado."
}
```

---

## üìù Formulario Web

### Funcionalidades

-   **Formulario de registro** con validaci√≥n en tiempo real
-   **Detecci√≥n autom√°tica** de zona horaria del usuario
-   **Validaci√≥n de tel√©fono** (debe empezar con 6 y tener 8 d√≠gitos)
-   **Validaci√≥n de email** con formato correcto
-   **Checkboxes opcionales** para notificaciones:
    -   ‚úÖ **Notificar por correo**: Env√≠a email de confirmaci√≥n
    -   ‚úÖ **Notificar por SMS**: Env√≠a SMS de confirmaci√≥n

### Campos del Formulario

-   **Nombre Completo**: Se separa autom√°ticamente en nombre y apellido
-   **Tipo de Documento**: C√©dula, Pasaporte, Otros
-   **N√∫mero de Documento**: Validaci√≥n autom√°tica (remueve guiones)
-   **Correo Electr√≥nico**: Validaci√≥n de formato
-   **Tel√©fono**: Debe empezar con 6 y tener 8 d√≠gitos
-   **Notificaciones**: Checkboxes opcionales

---

## ‚ú® Funcionalidades Destacadas

### üîß Procesamiento de Datos

-   **Separaci√≥n autom√°tica** de nombres y apellidos
-   **Captura de IP** del usuario autom√°ticamente
-   **Detecci√≥n de zona horaria** del navegador
-   **Validaci√≥n robusta** con mensajes de error personalizados

### üìß Sistema de Notificaciones

-   **Email condicional**: Solo se env√≠a si el usuario marca la casilla
-   **SMS condicional**: Solo se env√≠a si el usuario marca la casilla
-   **Plantilla HTML** profesional para emails
-   **Formateo autom√°tico** de n√∫meros de tel√©fono para SMS
-   **Manejo de errores** sin interrumpir el registro
-   **Soporte para colas** (opcional)

### üõ°Ô∏è Seguridad y Validaci√≥n

-   **API protegida** con token de autorizaci√≥n
-   **Validaci√≥n de datos** tanto en frontend como backend
-   **Sanitizaci√≥n** de n√∫meros de documento
-   **Manejo seguro** de errores

### üé® Interfaz de Usuario

-   **Dise√±o responsivo** con CSS personalizado
-   **Validaci√≥n en tiempo real** con JavaScript
-   **Mensajes de √©xito/error** informativos
-   **Experiencia de usuario** fluida

---

## üß™ Pruebas

### Probar el Formulario Web

1. Ve a `/personas/crear`
2. Llena todos los campos
3. Marca/desmarca "Notificar por correo" y "Notificar por SMS"
4. Env√≠a el formulario
5. Verifica el email y SMS si marcaste las opciones

### Probar la API

```bash
curl -X POST http://persona.test/api/personas \\
  -H "Authorization: AMAXONIA_TOKEN" \\
  -H "Content-Type: application/json" \\
  -d '{
    "nombre_completo": "Mar√≠a Gonz√°lez",
    "tipo_documento": "cedula",
    "nro_documento": "987654321",
    "correo_electronico": "maria@example.com",
    "telefono": "65555555",
    "timezone": "America/Panama",
    "notificar_por_correo": true,
    "notificar_por_sms": true
  }'
```

### Probar SMS con Tinker

```bash
php artisan tinker
```

```php
$sms = new App\\Services\\SmsService();
$resultado = $sms->sendSms('61234567', 'Mensaje de prueba desde Laravel');
dd($resultado);
```

### Verificar Logs

```bash
# Ver logs de la aplicaci√≥n
tail -f storage/logs/laravel.log

# Limpiar cach√© si hay problemas
php artisan config:clear
php artisan cache:clear
```

---

## üîß Soluci√≥n de Problemas

### Email no se env√≠a

1. **Verificar configuraci√≥n** en `.env`
2. **Confirmar App Password** de Gmail
3. **Revisar carpeta SPAM** del destinatario
4. **Verificar logs**: `tail -f storage/logs/laravel.log`

### SMS no se env√≠a

1. **Verificar credenciales** de Twilio en `.env`
2. **Confirmar que el n√∫mero FROM** sea un n√∫mero de Twilio v√°lido
3. **Verificar que el n√∫mero de destino** est√© verificado (solo para trial)
4. **Revisar saldo** de la cuenta de Twilio
5. **Verificar formato** del n√∫mero: +507XXXXXXXX

### Errores comunes de SMS

-   **Error 21211**: N√∫mero de destino no verificado (solo trial)
-   **Error 20003**: Credenciales de autenticaci√≥n incorrectas
-   **Error 21614**: N√∫mero de destino no es v√°lido para m√≥vil
-   **Error 21408**: Permisos insuficientes para el n√∫mero FROM

### Error de base de datos

1. **Verificar conexi√≥n** a MySQL
2. **Ejecutar migraciones**: `php artisan migrate`
3. **Verificar permisos** de la base de datos

### Problemas con colas

1. **Verificar configuraci√≥n**: `QUEUE_CONNECTION=database`
2. **Crear tabla de colas**: `php artisan queue:table && php artisan migrate`
3. **Ejecutar worker**: `php artisan queue:work`

---

## üìä Estructura de la Base de Datos

### Tabla: `personas`

```sql
- id (bigint, primary key)
- nombre (varchar 255)
- apellido (varchar 255)
- tipo_documento (varchar 50)
- nro_documento (varchar 100)
- correo_electronico (varchar 255)
- telefono (varchar 50)
- ip (varchar 45)
- timezone (varchar 100)
- registro_via (enum: 'web', 'mobile')
- notificacion_via_correo (boolean)
- notificacion_via_sms (boolean)
- created_at (timestamp)
- updated_at (timestamp)
```

---

## üèóÔ∏è Arquitectura del Proyecto

### Servicios

-   **SmsService**: Maneja el env√≠o de SMS con Twilio
-   **FormularioSubmitted**: Mailable para emails de confirmaci√≥n

### Controladores

-   **PersonaController**: Maneja el formulario web
-   **Api\\PersonaController**: Maneja las peticiones de la API

### Modelos

-   **Persona**: Modelo principal con validaciones y relaciones

### Middleware

-   **ValidateApiToken**: Valida el token de autorizaci√≥n para la API

---

## üöÄ Funcionalidades Implementadas

### ‚úÖ Completamente Funcional

-   ‚úÖ **Formulario web** con validaci√≥n
-   ‚úÖ **API REST** con autenticaci√≥n
-   ‚úÖ **Email real** (Gmail configurado)
-   ‚úÖ **SMS real** (Twilio configurado)
-   ‚úÖ **Notificaciones condicionales** (solo si se marcan las casillas)
-   ‚úÖ **Base de datos** funcionando
-   ‚úÖ **Validaciones robustas**
-   ‚úÖ **Manejo de errores**

### üìä Funcionalidades Avanzadas

-   ‚úÖ **Separaci√≥n autom√°tica** de nombres y apellidos
-   ‚úÖ **Captura de IP** y zona horaria
-   ‚úÖ **Formateo autom√°tico** de n√∫meros de tel√©fono
-   ‚úÖ **Sanitizaci√≥n** de documentos
-   ‚úÖ **Respuestas estructuradas** en JSON
-   ‚úÖ **Modo simulaci√≥n** para desarrollo sin credenciales

---

## üí∞ Costos y Consideraciones

### Twilio

-   **Cuenta Trial**: $15 USD gratis
-   **SMS a Panam√°**: ~$0.075 USD por SMS
-   **N√∫mero de tel√©fono**: ~$1 USD/mes
-   **Capacidad estimada**: ~200 SMS con cr√©dito gratis

### Gmail

-   **Gratis** hasta 500 emails por d√≠a
-   **Sin costo adicional** para App Passwords

---

## üìÑ Licencia

Este proyecto es de uso libre √∫nicamente con fines evaluativos.

---

## üë®‚Äçüíª Desarrollado por

**Jorshua Jim√©nez**  
GitHub: [@jorshuadev](https://github.com/jorshuadev)

---

## üÜò Soporte

Si encuentras alg√∫n problema:

1. **Revisa la documentaci√≥n** de configuraci√≥n
2. **Verifica los logs** de Laravel
3. **Consulta la documentaci√≥n** de [Twilio](https://www.twilio.com/docs)
4. **Abre un issue** en el repositorio de GitHub

```

## üéØ Resumen de Cambios Agregados

### ‚úÖ **Nuevas Secciones**:
- üì± **Configuraci√≥n completa de SMS con Twilio**
- üí∞ **Informaci√≥n de costos y limitaciones**
- üß™ **Pruebas espec√≠ficas para SMS**
- üîß **Soluci√≥n de problemas de SMS**
- üèóÔ∏è **Arquitectura del proyecto**

### ‚úÖ **Informaci√≥n Detallada**:
- **Proceso completo** de registro en Twilio
- **Configuraci√≥n paso a paso** de credenciales
- **Ejemplos de uso** con Tinker
- **Errores comunes** y sus soluciones
- **Costos estimados** de operaci√≥n

### ‚úÖ **Funcionalidades Actualizadas**:
- **Notificaciones duales** (Email + SMS)
- **Modo simulaci√≥n** para desarrollo
- **Validaci√≥n de n√∫meros** paname√±os
- **Manejo robusto de errores**

¬°El README ahora est√° completo con toda la informaci√≥n necesaria para implementar tanto email como SMS!
```
